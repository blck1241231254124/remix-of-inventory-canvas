generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  warehouse_staff
  purchasing
  requester
}

enum RequestStatus {
  pending
  approved
  rejected
  fulfilled
}

enum TransactionStatus {
  pending
  approved
  rejected
  completed
}

enum MovementType {
  in
  out
  transfer
  adjustment
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  name      String
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  itemRequests      ItemRequest[]
  approvedRequests  ItemRequest[]      @relation("ApprovedBy")
  incomingGoods     IncomingGoods[]
  outgoingGoods     OutgoingGoods[]
  stockMovements    StockMovement[]
  purchaseOrders    PurchaseOrder[]
  approvedPurchases PurchaseOrder[]    @relation("POApprovedBy")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items Item[]
}

model Supplier {
  id           String   @id @default(uuid())
  name         String
  contactName  String?
  email        String?
  phone        String?
  address      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  incomingGoods  IncomingGoods[]
  purchaseOrders PurchaseOrder[]
}

model Item {
  id           String   @id @default(uuid())
  sku          String   @unique
  name         String
  description  String?
  categoryId   String
  unit         String
  minStock     Int      @default(0)
  currentStock Int      @default(0)
  location     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  category           Category            @relation(fields: [categoryId], references: [id])
  itemRequests       ItemRequest[]
  incomingGoodsItems IncomingGoodsItem[]
  outgoingGoodsItems OutgoingGoodsItem[]
  stockMovements     StockMovement[]
  purchaseOrderItems PurchaseOrderItem[]
}

model ItemRequest {
  id            String        @id @default(uuid())
  requestNumber String        @unique
  itemId        String
  quantity      Int
  reason        String?
  status        RequestStatus @default(pending)
  requestedById String
  approvedById  String?
  approvedAt    DateTime?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  item        Item  @relation(fields: [itemId], references: [id])
  requestedBy User  @relation(fields: [requestedById], references: [id])
  approvedBy  User? @relation("ApprovedBy", fields: [approvedById], references: [id])
}

model IncomingGoods {
  id                String            @id @default(uuid())
  transactionNumber String            @unique
  supplierId        String
  receivedById      String
  receivedAt        DateTime          @default(now())
  notes             String?
  status            TransactionStatus @default(pending)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  supplier   Supplier            @relation(fields: [supplierId], references: [id])
  receivedBy User                @relation(fields: [receivedById], references: [id])
  items      IncomingGoodsItem[]
}

model IncomingGoodsItem {
  id              String @id @default(uuid())
  incomingGoodsId String
  itemId          String
  quantity        Int
  unitPrice       Float?

  incomingGoods IncomingGoods @relation(fields: [incomingGoodsId], references: [id], onDelete: Cascade)
  item          Item          @relation(fields: [itemId], references: [id])
}

model OutgoingGoods {
  id                String            @id @default(uuid())
  transactionNumber String            @unique
  destination       String
  issuedById        String
  issuedAt          DateTime          @default(now())
  notes             String?
  status            TransactionStatus @default(pending)
  recipientName     String?
  recipientSignature String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  issuedBy User                @relation(fields: [issuedById], references: [id])
  items    OutgoingGoodsItem[]
}

model OutgoingGoodsItem {
  id              String @id @default(uuid())
  outgoingGoodsId String
  itemId          String
  quantity        Int

  outgoingGoods OutgoingGoods @relation(fields: [outgoingGoodsId], references: [id], onDelete: Cascade)
  item          Item          @relation(fields: [itemId], references: [id])
}

model StockMovement {
  id            String       @id @default(uuid())
  itemId        String
  type          MovementType
  quantity      Int
  previousStock Int
  newStock      Int
  reference     String?
  notes         String?
  performedById String
  createdAt     DateTime     @default(now())

  item        Item @relation(fields: [itemId], references: [id])
  performedBy User @relation(fields: [performedById], references: [id])
}

model PurchaseOrder {
  id            String            @id @default(uuid())
  orderNumber   String            @unique
  supplierId    String
  status        TransactionStatus @default(pending)
  totalAmount   Float             @default(0)
  notes         String?
  createdById   String
  approvedById  String?
  approvedAt    DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  supplier   Supplier            @relation(fields: [supplierId], references: [id])
  createdBy  User                @relation(fields: [createdById], references: [id])
  approvedBy User?               @relation("POApprovedBy", fields: [approvedById], references: [id])
  items      PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id              String @id @default(uuid())
  purchaseOrderId String
  itemId          String
  quantity        Int
  unitPrice       Float

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item          Item          @relation(fields: [itemId], references: [id])
}
